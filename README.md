# Async log watch

`async_log_watch` is a simple Rust library developed as a part of a personal project. It is designed to monitor log files and trigger an async callback whenever a new line is added to the file. The library allows users to easily integrate log file monitoring into their projects, with support for monitoring multiple log files simultaneously.

The primary motivation behind creating this library was to efficiently detect new log lines generated by tools like `pm2`. The library is built using the `async-std` (can use the tokio by adding tokio runtime feature) and the `notify` crate for file system event monitoring.


## Usage

Add `async-log-watch` to your `Cargo.toml` dependencies:

```toml
[dependencies]
async-log-watch = {version = "0.1"}
```

### Example

```rust
use async_log_watch::{LogWatcher, LogError};

#[async_std::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let mut log_watcher = LogWatcher::new();

    let filepath = "~/.pm2/logs/r1-out.log";
    log_watcher
        .register(filepath, |line: String, err: Option<LogError>| async move {
            if err.is_none() {
                println!("New log line: {}", line);
            } else {
                eprintln!("{}", err.unwrap());
            }
        })
        .await;

    log_watcher
        .monitoring(std::time::Duration::from_secs(1))
        .await?;
    Ok(())
}

```

## Features

This crate allows you to use `tokio` runtime featured in `async-std` by specifying features in your `Cargo.toml`. By default, it uses `async-std` with the `attributes` feature. 

To use the crate with the default configuration, add the following line to your `Cargo.toml`:

```toml
async-log-watch = "0.1"
```

To use a specific Tokio configuration, specify the feature like this:

```toml
my-crate = { version = "0.1", features = ["tokio1"] }
```

### Available Features

- **default**: Uses `async-std` with the `attributes` feature.
- **tokio1**: Uses `async-std` with the `attributes` and `tokio1` features.
- **tokio02**: Uses `async-std` with the `attributes` and `tokio02` features.
- **tokio03**: Uses `async-std` with the `attributes` and `tokio03` features.

Please note that you should only enable one of these features at a time.


## TODO

- [x] Implement basic log monitoring.
- [x] Support async callbacks
- [x] Allow monitoring multiple log files simultaneously
- [X] Update with new version of dependencies.
- [x] FIXED: When convert into absolute filepath, tilde('~') is used as folder name.
- [x] FIXED: At the first time, watcher read the first line.
- [x] Error handling for file read errors
- [x] Improve error handling with the `thiserror` library. - file errors occurs in spawn. 
- [x] Notify error through callback

**~~Add support for log file rotation~~** (decided not to add support)
- [x] Added methods : stop_monitoring_file and change_file_path
- [x] FIXED: absolute path in added methods | test code 
- [ ] Update the callback function's arguments to include the functionalities.
	- It allows user to handle log file rotation in the callback function when receiving a file open error
- [x] ~~Add support for other async runtimes (tokio)~~ 
- [x] Add support tokio runtime features in async-std


## Future Works

- Add filtering options to process specific log lines based on patterns

## License

This project is licensed under the MIT License - see the [LICENSE](./LICENSE) file for details.
